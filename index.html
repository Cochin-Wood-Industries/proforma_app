<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proforma Invoice</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 14px;
            color: #333;
        }
        address { font-style: normal; }
        [contenteditable="true"] {
            display: inline-block; min-width: 50px; border-bottom: 1px dashed #c1d6e1;
            padding: 2px; outline: none; cursor: text; transition: all 0.2s;
        }
        [contenteditable="true"]:hover, [contenteditable="true"]:focus { border-bottom-color: #004343; background-color: #f0f8ff; }
        input, select {
            border: 1px solid #c1d6e1; padding: 2px 4px; border-radius: 4px; outline: none;
            transition: all 0.2s;
        }
        input:hover, select:hover, input:focus, select:focus { border-color: #004343; background-color: #f0f8ff; }
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: #004343; color: white; padding: 1rem 2rem; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 1000; display: none;
            animation: fadeInOut 3s forwards; font-weight: 500;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) scale(0.9); }
            10%, 90% { opacity: 1; transform: translateX(-50%) scale(1); }
        }
        
        /* A4 Paper Optimization for printing */
        .invoice-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: none;
        }
        .invoice-container, body { background-color: white; }

        /* Table Layout for both screen and print */
        .table-container table {
            table-layout: fixed;
            width: 100%;
        }
        /* prevent header labels from squishing */
        .table-container table th {
            white-space: normal;
            overflow-wrap: anywhere;
        }

        /* Screen-specific styling */
        @media screen {
            .customer-info { display: flex; flex-direction: column; }
            @media (min-width: 768px) {
                .customer-info { flex-direction: row; }
            }
        }

        @media print {
            @page { size: A4; margin: 34mm 10mm 10mm 10mm; }
            @page:first { margin: 10mm 10mm 10mm 10mm; }
            body { margin: 0; font-size: 12px; color: #000; }
            .invoice-container {
                width: 100%; min-height: 0; padding: 0; box-shadow: none;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            .print-keep-together { break-inside: avoid; page-break-inside: avoid; }
            #finalSection { min-height: 55mm; }
            #termsBlock{ break-inside: avoid; page-break-inside: avoid; }
            .keep-with-next { break-after: avoid; page-break-after: avoid; }
            #items-summary tr:first-child { break-before: avoid; page-break-before: avoid; }
            .no-print, .add-remove-buttons { display: none !important; }
            .print-hide-if-empty.hidden-for-print { display: none !important; }
            [contenteditable="true"], input, select { border: none !important; background-color: transparent !important; padding: 0; }
            .delete-item-btn { display: none; }
            thead { display: table-header-group; }
            tr, tfoot { page-break-inside: avoid; }
            .item-particulars { white-space: pre-wrap; word-wrap: break-word; text-align: left !important; display: block !important; }
            footer{ page-break-before: auto !important; break-inside: avoid; page-break-inside: avoid; }
            .customer-info { display: flex; flex-direction: row; justify-content: space-between; gap: 16px; }
            .open-features-btn { display: none !important; }
        }

        /* Modal Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 8px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.2); width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
        }
    </style>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'primary-dark': '#004343', 'secondary-accent': '#009a7b', 'light-accent': '#11c99d', 'dark-shade': '#0a5e5e' }}}
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">
    <div id="message-box" class="message-box"></div>

    <div class="invoice-container max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
        <header class="flex flex-col md:flex-row justify-between items-start border-b-2 border-primary-dark pb-6 mb-6">
            <div class="w-full md:w-1/2 mb-6 md:mb-0">
                <div class="flex items-center mb-2">
                    <img src="https://www.cochinwood.in/web/image/8821-587dfee3/logo.png" alt="Cochin Wood Industries Logo" class="w-12 h-12 rounded-full object-cover shadow-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/48x48/004343/ffffff?text=CWI';">
                    <h2 class="text-lg font-bold text-teal-600">Cochin Wood Industries Private Limited</h2>
                </div>
                <address class="text-xs text-dark-shade leading-snug pl-16">
                    <p>Thoppilan Building, 146/A, Thuruthy, Kuruppampady,<br>Ernakulam, Kerala – 683545, India</p>
                    <p class="mt-1">Phone: <span class="font-semibold">+91 9567410175</span> | E-Mail: <span class="font-semibold">info@cochinwood.in</span></p>
                    <p class="mt-1">GSTIN: <span class="font-semibold">32AAJCC9689H1Z5</span></p>
                </address>
            </div>
            
            <div class="flex flex-col items-start md:items-end w-full md:w-1/2">
                <h1 class="text-3xl font-extrabold text-primary-dark mb-4">PROFORMA INVOICE</h1>
                <div class="w-full border-l-4 border-light-accent pl-4 py-3 rounded-md">
                    <div class="flex justify-between items-center mb-1"><strong class="text-sm font-bold text-primary-dark mr-2">P.I. No:</strong> <span id="invoiceNumber" contenteditable="true" class="text-right flex-grow font-semibold min-w-[120px]" aria-label="Proforma Invoice Number"></span></div>
                    <div class="flex justify-between items-center mb-1"><strong class="text-sm font-bold text-primary-dark mr-2">Date:</strong> <input type="date" id="invoiceDate" class="w-auto text-right flex-grow"></div>
                    <div class="flex justify-between items-center mb-1"><strong class="text-sm font-bold text-primary-dark mr-2">Valid Till:</strong> <input type="date" id="validTill" class="w-auto text-right flex-grow"></div>
                    <div class="flex justify-between items-center"><strong class="text-sm font-bold text-primary-dark mr-2">Currency:</strong>
                        <span id="currencyDisplay" class="w-auto text-sm bg-white text-right font-bold">INR (₹)</span>
                    </div>
                </div>
            </div>
        </header>

        <section class="details-section mb-8 text-sm">
            <div class="customer-info w-full gap-4 space-y-6 md:space-y-0">
                <div class="w-full md:w-1/3 border-l-4 border-secondary-accent pl-4 py-3 rounded-md ">
                    <strong class="block mb-2 text-base font-bold text-primary-dark">Customer Details:</strong>
                    <div class="space-y-1 text-xs">
                        <p>Name: <span id="clientName" contenteditable="true" class="font-semibold" aria-label="Customer Name"></span></p>
                        <p>Company: <span id="clientCompany" contenteditable="true" class="font-semibold" aria-label="Customer Company"></span></p>
                        <p>GSTIN: <span id="clientGSTIN" contenteditable="true" class="font-semibold" aria-label="Customer GSTIN"></span></p>
                    </div>
                </div>

                <div class="w-full md:w-1/3 border-l-4 border-secondary-accent pl-4 py-3 rounded-md">
                    <strong class="block mb-2 text-base font-bold text-primary-dark">Billing Address:</strong>
                    <div class="space-y-1 text-xs">
                        <p>Address: <span id="billingAddressLine" contenteditable="true" class="font-semibold" aria-label="Billing Address"></span></p>
                        <p>District:
                            <select id="billingDistrictSelect" class="bg-transparent border-none p-0 inline-block w-28 font-semibold" disabled>
                                <option value="">Select District</option>
                            </select>
                        </p>
                        <p>State/UT:
                            <select id="billingStateSelect" class="bg-transparent border-none p-0 inline-block w-28 font-semibold">
                                <option value="">Select State/UT</option>
                            </select>
                        </p>
                    </div>
                </div>

                <div class="w-full md:w-1/3 border-l-4 border-secondary-accent pl-4 py-3 rounded-md">
                    <strong class="block mb-2 text-base font-bold text-primary-dark">Shipping Address:</strong>
                    <div class="space-y-1 text-xs">
                        <p>Address: <span id="shippingAddressLine" contenteditable="true" class="font-semibold" aria-label="Shipping Address"></span></p>
                        <p>District:
                            <select id="shippingDistrictSelect" class="bg-transparent border-none p-0 inline-block w-28 font-semibold" disabled>
                                <option value="">Select District</option>
                            </select>
                        </p>
                        <p>State/UT:
                            <select id="shippingStateSelect" class="bg-transparent border-none p-0 inline-block w-28 font-semibold">
                                <option value="">Select State/UT</option>
                            </select>
                        </p>
                    </div>
                    <button id="copyBillingBtn" class="mt-4 bg-gray-200 text-gray-700 font-medium py-1 px-3 rounded-lg text-xs hover:bg-gray-300 no-print">
                        Copy from Billing
                    </button>
                </div>
            </div>
        </section>

        <main>
            <!-- ITEMS TABLE -->
            <div class="table-container">
                <table class="w-full border-collapse mb-6 bg-gray-50 text-sm rounded-lg overflow-hidden shadow-sm">
                    <thead class="bg-primary-dark text-white text-left">
                        <tr>
                            <th scope="col" class="py-3 px-2" style="width: 6%;">S.No</th>
                            <th scope="col" class="py-3 px-2" style="width: 30%;">Particulars</th>
                            <th scope="col" class="py-3 px-2" style="width: 8%;">Thk<br>(mm)</th>
                            <th scope="col" class="py-3 px-2" style="width: 7%;">Len<br>(ft)</th>
                            <th scope="col" class="py-3 px-2" style="width: 7%;">Brd<br>(ft)</th>
                            <th scope="col" class="py-3 px-2" style="width: 9%;">Qty<br>(Sht)</th>
                            <th scope="col" class="py-3 px-2" style="width: 10%;">Qty<br>(SqFt)</th>
                            <th scope="col" class="py-3 px-2" style="width: 10%;">Rate/<br>SqFt</th>
                            <th scope="col" class="py-3 px-2 text-right" style="width: 12%;">Amount</th>
                            <th scope="col" class="py-3 px-2 no-print" style="width: 5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="invoiceItems"></tbody>
                    <tbody>
                        <tr class="font-bold">
                            <td colspan="8" class="border-t pt-4 pr-4 text-right">Subtotal</td>
                            <td id="subtotalAmount" class="border-t pt-4 pr-2 text-right">₹0.00</td>
                            <td class="border-t pt-4 no-print"></td>
                        </tr>
                        <tr class="font-bold">
                            <td colspan="8" class="pt-2 pr-4 text-right">
                                <div class="flex justify-end items-center space-x-2">
                                    <span>GST</span>
                                    <select id="gstRateSelect" class="w-auto text-sm bg-gray-50 border border-gray-300 rounded-md p-1">
                                        <option value="0.001">Supply to Merchant Exporter (0.1%)</option>
                                        <option value="0.05">5%</option>
                                        <option value="0.12">12%</option>
                                        <option value="0.18" selected>18%</option>
                                        <option value="0.28">28%</option>
                                    </select>
                                </div>
                            </td>
                            <td id="taxAmount" class="pt-2 pr-2 text-right">₹0.00</td>
                            <td class="pt-2 no-print"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- NEW: Add Product (+) button ABOVE transportation -->
            <div class="no-print mt-2 mb-6 text-right add-remove-buttons">
                <button id="addItemBtn"
                        class="w-8 h-8 flex items-center justify-center bg-secondary-accent hover:bg-dark-shade text-white font-bold rounded-full shadow-md transition-transform hover:scale-110"
                        aria-label="Add new item row">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- TRANSPORTATION -->
            <button id="addTransportationBtn" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hover:bg-gray-300 no-print mb-6">
                Add Transportation
            </button>

            <div id="transportationSection" class="hidden">
                <div class="table-container mt-8">
                    <table class="w-full border-collapse mb-6 bg-gray-50 text-sm rounded-lg overflow-hidden shadow-sm">
                        <thead class="bg-primary-dark text-white text-left">
                          <tr>
                            <th scope="col" class="py-3 px-2" style="width: 6%;">S.No</th>
                            <th scope="col" class="py-3 px-2" style="width: 20%;">Destination</th>
                            <th scope="col" class="py-3 px-2" style="width: 15%;">Distance<br>(km)</th>
                            <th scope="col" class="py-3 px-2" style="width: 15%;">Weight<br>(Tonne)</th>
                            <th scope="col" class="py-3 px-2" style="width: 15%;">Rate/<br>Tonne</th>
                            <th scope="col" class="py-3 px-2 text-right" style="width: 20%;">Amount</th>
                            <th scope="col" class="py-3 px-2 no-print" style="width: 9%;"></th>
                          </tr>
                        </thead>

                        <tbody id="transportationItems"></tbody>
                        <tfoot>
                            <tr class="font-bold">
                                <td colspan="5" class="border-t pt-4 pr-4 text-right">Subtotal</td>
                                <td id="transportationSubtotalAmount" class="border-t pt-4 pr-2 text-right">₹0.00</td>
                                <td class="border-t pt-4 no-print"></td>
                            </tr>
                            <tr class="font-bold">
                                <td colspan="5" class="pt-2 pr-4 text-right">
                                    <div class="flex justify-end items-center space-x-2">
                                        <span>GST</span>
                                        <select id="transportationGstRateSelect" class="w-auto text-sm bg-gray-50 border border-gray-300 rounded-md p-1">
                                            <option value="0.05" selected>5%</option>
                                            <option value="0.12">12%</option>
                                            <option value="0.18">18%</option>
                                            <option value="0.28">28%</option>
                                        </select>
                                    </div>
                                </td>
                                <td id="transportationTaxAmount" class="pt-2 pr-2 text-right">₹0.00</td>
                                <td class="pt-2 no-print"></td>
                            </tr>
                            <tr class="no-print">
                                <td colspan="7" class="pt-4 pb-2 text-right add-remove-buttons">
                                    <button id="addTransportationItemBtn" class="w-8 h-8 flex items-center justify-center bg-secondary-accent hover:bg-dark-shade text-white font-bold rounded-full shadow-md transition-transform hover:scale-110" aria-label="Add new transportation row">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                                    </button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

          <div id="finalSection" class="print-keep-together">

            <div class="table-container">
                <table class="w-full border-collapse mb-6 bg-gray-50 text-sm rounded-lg overflow-hidden shadow-sm">
                    <tfoot>
                        <tr class="text-base font-extrabold">
                            <td colspan="8" class="border-t-2 border-primary-dark pt-4 pr-2 text-right">Total Weight (kg)</td>
                            <td id="totalWeightAmount" class="border-t-2 border-primary-dark pt-4 pr-2 text-right">0.00</td>
                            <td class="border-t-2 border-primary-dark pt-4 no-print"></td>
                        </tr>
                        <tr class="text-lg font-extrabold">
                            <td colspan="8" class="border-t-2 border-primary-dark pt-4 pr-2 text-right">Grand Total</td>
                            <td id="grandTotalAmount" class="border-t-2 border-primary-dark pt-4 pr-2 text-right">₹0.00</td>
                            <td class="border-t-2 border-primary-dark pt-4 no-print"></td>
                        </tr>
                        <!-- removed old addItemBtn row from here -->
                    </tfoot>
                </table>
            </div>
          
            <div class="flex justify-between mt-16 gap-8">
              <div class="w-5/12 text-center">
                <div id="preparedByName" contenteditable="true" class="text-base font-semibold mb-4" aria-label="Prepared By Name">Name</div>
                <div class="border-t border-primary-dark pt-3 text-sm">Prepared By</div>
              </div>
              <div class="w-5/12 text-center">
                <div id="salesManagerName" contenteditable="true" class="text-base font-semibold mb-4" aria-label="Sales Manager Name">Name</div>
                <div class="border-t border-primary-dark pt-3 text-sm">Sales Manager</div>
              </div>
            </div>

          </div>

        </main>
        
        <footer class="mt-8">
            <div class="flex flex-col md:flex-row justify-between">
                <div class="w-full md:w-4/12 border-l-4 border-secondary-accent pl-4 py-3 rounded-md mb-6 md:mb-0">
                    <strong class="block mb-2 text-sm font-bold text-primary-dark">Bank Details:</strong>
                    <address class="text-xs leading-snug">
                        <p>A/C Name: <span class="font-semibold">Cochin Wood Industries Pvt Ltd</span></p>
                        <p>A/C No: <span class="font-semibold">074305002785</span></p>
                        <p>Bank: <span class="font-semibold">ICICI Bank, Perumbavoor</span></p>
                        <p>IFSC: <span class="font-semibold">ICIC0000743</span></p>
                    </address>
                    <div class="flex flex-col items-center mt-4 text-center">
                        <strong class="block mb-1 text-sm font-bold text-primary-dark">UPI ID:</strong>
                        <p class="text-xs font-semibold">cochinwoodindustriesprivatelimited.ibz<br>@icici</p>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=upi://pay?pa=cochinwoodindustriesprivatelimited.ibz@icici" alt="UPI QR Code" class="w-24 h-24 mt-2">
                        <p class="text-xs font-semibold mt-1">Scan & Pay</p>
                    </div>
                </div>

                <div id="termsBlock" class="w-full md:w-7/12 border-l-4 border-secondary-accent pl-4 py-3 rounded-md">
                    <strong class="block mb-2 text-sm font-bold text-primary-dark">Terms & Conditions:</strong>
                    <ul class="list-disc pl-4 mt-2 text-xs space-y-1">
                        <li>**Pricing:** Valid for 3 days from quote/proforma date.</li>
                        <li>**Payment:** 50% advance on order acceptance; balance due post-production, pre-dispatch.</li>
                        <li>**Delivery:** 7-15 days (estimated). Shipping charges apply. Shipping risk transfers upon transporter/carrier.</li>
                        <li>**Inspection:** Quality inspection before loading. Report defects within 5 days of receipt.</li>
                        <li>**Warranty:** Point of Sale warranty.</li>
                        <li>**Liability:** No indirect damages. Liability limited to purchase amount.</li>
                        <li>**Confidentiality:** Mutual confidentiality agreement.</li>
                        <li>**Tolerance:** +/-5% loading tolerance.</li>
                        <li>**Law:** Governed by Indian law. Disputes resolved in Perumbavoor Jurisdiction.</li>
                        <li>**Force Majeure:** Not liable for delays due to uncontrollable events like natural disasters, pandemics, governmental actions, etc.</li>
                        <li id="orderSpecificTandC_li" class="print-hide-if-empty">**Order Specific T&C:** <span id="orderSpecificTandC" contenteditable="true" class="font-semibold" aria-label="Order specific terms and conditions">N/A</span></li>
                    </ul>
                    <div class="mt-4">
                        <strong class="block mb-2 text-sm font-bold text-primary-dark">Incoterms:</strong>
                        <select id="incoterms" class="w-full text-xs bg-gray-50 border border-gray-300 rounded-md p-1">
                            <option value="EXW" selected>Ex Works (EXW)</option>
                            <option value="FCA">Free Carrier (FCA)</option>
                            <option value="DAP">Delivered at Place (DAP)</option>
                        </select>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <div id="productOptionsModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-primary-dark mb-4">Select Product Features</h3>
            <div id="productOptionsContent" class="space-y-4"></div>
            <div class="flex justify-end space-x-2 mt-6">
                <button id="cancelModalBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
                <button id="saveModalBtn" class="bg-secondary-accent text-white px-4 py-2 rounded-lg hover:bg-dark-shade">Save</button>
            </div>
        </div>
    </div>

    <datalist id="product-list"></datalist>

    <div class="no-print mt-6 text-center">
        <button id="saveToSheetBtn" class="bg-secondary-accent text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-dark-shade transition-colors">
            Save to Google Sheet
        </button>
        <button id="printBtn" class="bg-gray-500 text-white font-bold py-2 px-4 ml-4 rounded-lg shadow-md hover:bg-gray-700 transition-colors" onclick="window.print();">
            Print Invoice
        </button>
    </div>

    <script>
        let productMasterData = []; 
        window.productMasterData = productMasterData;
        let currentItemRow;
        let availableFeatures = [];

        const FT_TO_M = 0.3048;

        function computeRowWeightFromValues(lengthFt, breadthFt, thicknessMm, quantity, opts = {}) {
            const fixedWeight = opts.fixedWeight != null ? Number(opts.fixedWeight) : null;
            const density = (opts.density != null ? Number(opts.density) : (opts.isMarine ? 700 : 600));
            if (!isNaN(fixedWeight) && fixedWeight > 0) {
                return (Number(quantity) || 0) * fixedWeight;
            }
            const Lm = (Number(lengthFt) || 0) * FT_TO_M;
            const Bm = (Number(breadthFt) || 0) * FT_TO_M;
            const thicknessM = (Number(thicknessMm) || 0) / 1000;
            const qty = Number(quantity) || 0;
            const area = Lm * Bm;
            const perSheet = density * thicknessM * area;
            return perSheet * qty;
        }

        function getRowWeightHints(tr, selectedProductName = "") {
            const fixedWeight = tr?.dataset?.fixedWeight ? Number(tr.dataset.fixedWeight) : null;
            const density = tr?.dataset?.density ? Number(tr.dataset.density) : null;
            const isMarine = /marine/i.test(selectedProductName || "");
            return { fixedWeight, density, isMarine };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const invoiceItems = document.getElementById('invoiceItems');
            const addItemBtn = document.getElementById('addItemBtn');
            const subtotalAmount = document.getElementById('subtotalAmount');
            const taxAmount = document.getElementById('taxAmount');
            const grandTotalAmount = document.getElementById('grandTotalAmount');
            const totalWeightAmount = document.getElementById('totalWeightAmount');
            const invoiceDate = document.getElementById('invoiceDate');
            const billingStateSelect = document.getElementById('billingStateSelect');
            const billingDistrictSelect = document.getElementById('billingDistrictSelect');
            const shippingStateSelect = document.getElementById('shippingStateSelect');
            const shippingDistrictSelect = document.getElementById('shippingDistrictSelect');
            const copyBillingBtn = document.getElementById('copyBillingBtn');
            const messageBox = document.getElementById('message-box');
            const gstRateSelect = document.getElementById('gstRateSelect');
            const invoiceNumberEl = document.getElementById('invoiceNumber');
            
            const addTransportationBtn = document.getElementById('addTransportationBtn');
            const transportationSection = document.getElementById('transportationSection');
            const addTransportationItemBtn = document.getElementById('addTransportationItemBtn');
            const transportationItems = document.getElementById('transportationItems');
            const transportationSubtotalAmount = document.getElementById('transportationSubtotalAmount');
            const transportationTaxAmount = document.getElementById('transportationTaxAmount');
            const transportationGstRateSelect = document.getElementById('transportationGstRateSelect');

            const productOptionsModal = document.getElementById('productOptionsModal');
            const productOptionsContent = document.getElementById('productOptionsContent');
            const saveModalBtn = document.getElementById('saveModalBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');

            const today = new Date().toISOString().split('T')[0];
            invoiceDate.value = today;

            function generatePiNo() {
              const d = new Date();
              const yyyy = d.getFullYear();
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const dd = String(d.getDate()).padStart(2, '0');
              const yyyymmdd = `${yyyy}${mm}${dd}`;
              const key = `piSeq-${yyyymmdd}`;
              const next = (parseInt(localStorage.getItem(key) || '0', 10) + 1);
              localStorage.setItem(key, String(next));
              const seq = String(next).padStart(3, '0');
              return `PI-${yyyymmdd}-${seq}`;
            }
            if (invoiceNumberEl && invoiceNumberEl.textContent.trim() === '') {
              invoiceNumberEl.textContent = generatePiNo();
            }

            const showMessage = (message, duration = 3000) => {
                messageBox.textContent = message;
                messageBox.style.display = 'block';
                setTimeout(() => { messageBox.style.display = 'none'; }, duration);
            };

            const formatCurrency = (amount) => `₹${parseFloat(amount).toFixed(2)}`;

            const updateTotals = () => {
                let subtotal = 0;
                let totalWeight = 0;

                document.querySelectorAll('.item-row').forEach(row => {
                    const amountText = row.querySelector('.item-amount').textContent;
                    subtotal += parseFloat(amountText) || 0;

                    const thk = parseFloat(row.querySelector('.item-thk').value) || 0;
                    const len = parseFloat(row.querySelector('.item-len').value) || 0;
                    const brd = parseFloat(row.querySelector('.item-brd').value) || 0;
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const selectedName = row.querySelector('.product-search-input')?.value || '';
                    const hints = getRowWeightHints(row, selectedName);
                    totalWeight += computeRowWeightFromValues(len, brd, thk, qty, hints);
                });
                
                const selectedGstRate = parseFloat(gstRateSelect.value);
                const tax = subtotal * selectedGstRate;

                subtotalAmount.textContent = formatCurrency(subtotal);
                taxAmount.textContent = formatCurrency(tax);

                const transportationSubtotal = parseFloat(transportationSubtotalAmount.textContent.replace('₹', '')) || 0;
                const transportationTax = parseFloat(transportationTaxAmount.textContent.replace('₹', '')) || 0;

                const grandTotal = subtotal + tax + transportationSubtotal + transportationTax;
                grandTotalAmount.textContent = formatCurrency(grandTotal);

                totalWeightAmount.textContent = (totalWeight || 0).toFixed(2);
            };
            
            const updateTransportationTotals = () => {
                let transportationSubtotal = 0;
                document.querySelectorAll('.transportation-row').forEach(row => {
                    const amountText = row.querySelector('.transportation-amount').textContent;
                    transportationSubtotal += parseFloat(amountText) || 0;
                });

                const selectedGstRate = parseFloat(transportationGstRateSelect.value) || 0;
                const transportationTax = transportationSubtotal * selectedGstRate;

                transportationSubtotalAmount.textContent = formatCurrency(transportationSubtotal);
                transportationTaxAmount.textContent = formatCurrency(transportationTax);

                updateTotals();
            };

            const createItemRow = (sno) => {
                const tr = document.createElement('tr');
                tr.className = 'item-row text-center';
                tr.innerHTML = `
                    <td class="border-t py-2 px-2 text-left" style="width: 6%;">${sno}</td>
                    <td class="border-t py-2 px-2" style="width: 30%;">
                        <div contenteditable="true" class="item-particulars w-full bg-transparent border-none p-0 text-left cursor-text" aria-label="Particulars" tabindex="0"></div>
                        <input type="text" list="product-list" class="product-search-input w-full bg-transparent border-none p-0 text-left mt-1" aria-label="Product Search">
                        <button type="button" class="open-features-btn hidden text-xs px-2 py-1 rounded ml-2 bg-[#008080] text-white hover:bg-[#006666] transition-colors" aria-label="Open feature selection">Features</button>
                    </td>
                    <td class="border-t py-2 px-2" style="width: 8%;"><input type="number" step="1" class="item-thk w-full bg-transparent border-none p-0 text-center"></td>
                    <td class="border-t py-2 px-2" style="width: 7%;"><input type="number" step="1" class="item-len w-full bg-transparent border-none p-0 text-center"></td>
                    <td class="border-t py-2 px-2" style="width: 7%;"><input type="number" step="1" class="item-brd w-full bg-transparent border-none p-0 text-center"></td>
                    <td class="border-t py-2 px-2" style="width: 9%;"><input type="number" step="1" class="item-qty w-full bg-transparent border-none p-0 text-center"></td>
                    <td class="item-sqft border-t py-2 px-2 text-right" style="width: 10%;">0.00</td>
                    <td class="border-t py-2 px-2" style="width: 10%;"><input type="number" step="1" class="item-rate w-full bg-transparent border-none p-0 text-center"></td>
                    <td class="item-amount border-t py-2 px-2 text-right" style="width: 12%;">0.00</td>
                    <td class="border-t no-print text-center" style="width: 5%;">
                        <button class="remove-item-btn w-6 h-6 flex items-center justify-center text-white bg-red-500 hover:bg-red-700 rounded-full transition-colors" aria-label="Remove item">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </td>
                `;

                const inputs = tr.querySelectorAll('.item-thk, .item-len, .item-brd, .item-qty, .item-rate');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        const thk = parseFloat(tr.querySelector('.item-thk').value) || 0;
                        const len = parseFloat(tr.querySelector('.item-len').value) || 0;
                        const brd = parseFloat(tr.querySelector('.item-brd').value) || 0;
                        const qty = parseFloat(tr.querySelector('.item-qty').value) || 0;
                        const rate = parseFloat(tr.querySelector('.item-rate').value) || 0;

                        const sqft = (len * brd * qty).toFixed(2);
                        const amount = (sqft * rate).toFixed(2);
                        
                        tr.querySelector('.item-sqft').textContent = sqft;
                        tr.querySelector('.item-amount').textContent = amount;
                        updateTotals();
                    });
                });

                tr.querySelector('.remove-item-btn').addEventListener('click', () => {
                    if (invoiceItems.children.length > 1) {
                        tr.remove();
                        updateSno();
                        updateTotals();
                    } else {
                        showMessage("You must have at least one item on the invoice.");
                    }
                });

                tr.querySelector('.product-search-input').addEventListener('input', (event) => {
                    const selectedName = event.target.value;
                    const matchingProducts = productMasterData.filter(p => p['Product Name'] === selectedName);
                    if (matchingProducts.length > 0) {
                        currentItemRow = tr;
                        showProductOptionsModal(matchingProducts);
                    }
                    const featuresBtnToggle = tr.querySelector('.open-features-btn');
                    if (featuresBtnToggle) {
                        featuresBtnToggle.classList.toggle('hidden', matchingProducts.length === 0);
                    }
                });
    
                tr.querySelector('.product-search-input').addEventListener('change', (event) => {
                    const selectedName = event.target.value;
                    const matchingProducts = (window.productMasterData || productMasterData || []).filter(p => p['Product Name'] === selectedName);
                    const featuresBtnToggle = tr.querySelector('.open-features-btn');
                    if (featuresBtnToggle) {
                        featuresBtnToggle.classList.toggle('hidden', matchingProducts.length === 0);
                    }
                    if (matchingProducts.length > 0) {
                        currentItemRow = tr;
                        showProductOptionsModal(matchingProducts);
                    }
                });

                const featuresBtn = tr.querySelector('.open-features-btn');
                if (featuresBtn) {
                    featuresBtn.addEventListener('click', () => {
                        const selectedName = tr.querySelector('.product-search-input').value.trim();
                        if (!selectedName) { showMessage('Please select a product first.'); return; }
                        const data = (window.pr
